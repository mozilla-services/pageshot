#!/usr/bin/env bash

set -eu

export NODE_ENV=production
cd "$(dirname ${BASH_SOURCE[0]})/.."

if [[ $# = 0 ]] ; then
  echo "Usage: $0 dockerhubusername"
  echo "  builds the pageshot docker image"
  echo "  tags and uploads it as [dockerhubusername]/pageshot:latest"
  echo "  creates build/eb-app-latest.zip"
  exit 4
fi

sed "s!USERNAME!$1!g" < Dockerrun.aws.json.template > Dockerrun.aws.json
zip -r build/eb-app-latest.zip Dockerrun.aws.json .ebextensions/*.config
rm Dockerrun.aws.json

make server

xpi="build/mozilla-pageshot.xpi"
if [[ ! -e "$xpi" ]] ; then
  make xpi
fi
# The signing process adds this META-INF directory to the xpi file
# (which is a zip file).  If it's not present then this is an unsigned
# addon, which we don't accept!
if unzip -v $xpi | grep -q META-INF ; then
  echo "Signed xpi found"
else
  rm -f ./page_shot-*-fx.xpi
  jpm sign --api-key=${AMO_USER} --api-secret=${AMO_SECRET} --xpi=${xpi}
  mv `ls ./page_shot-*-fx.xpi` ${xpi}
fi

docker build -t $1/pageshot:latest .
docker push $1/pageshot
echo "Complete.  Upload build/eb-app-latest.zip to http://amzn.to/1NuC3N9"
